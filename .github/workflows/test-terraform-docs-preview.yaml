name: Test Terraform Docs Preview

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'package*.json'
      - 'examples/**'
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Test screenshot generation with example files
  test-generate:
    runs-on: ubuntu-latest
    outputs:
      preview_count: ${{ steps.count.outputs.count }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies & Playwright
        run: |
          set -eu
          npm ci
          npx playwright install chromium

      - name: Generate screenshots for example files
        run: |
          set -eu
          mkdir -p screenshots

          # Test with all example markdown files
          find examples/docs -name "*.md" | while read -r file; do
            echo "Processing: $file"
            node scripts/preview-docs.js "$file" || {
              echo "::error::Failed to generate preview for $file"
              exit 1
            }
          done

      - name: Count generated screenshots
        id: count
        run: |
          set -eu
          count=$(find screenshots -type f -name "*.png" 2>/dev/null | wc -l)
          echo "Generated $count screenshots"
          echo "count=${count}" >> "$GITHUB_OUTPUT"

          # Verify at least one screenshot was generated
          if [ "$count" -eq 0 ]; then
            echo "::error::No screenshots were generated"
            exit 1
          fi

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v5
        with:
          name: test-screenshots
          path: screenshots
          retention-days: 1

      - name: List generated files
        run: |
          echo "Generated screenshots:"
          find screenshots -type f -name "*.png" -exec ls -lh {} \;

  # Test the reusable workflow with mock data
  test-reusable-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v5

      - name: Verify workflow files exist
        run: |
          set -eu
          echo "Checking workflow files..."

          workflows=(
            ".github/workflows/terraform-docs-preview.yaml"
            ".github/workflows/create-preview-image.yaml"
            ".github/workflows/upload-s3.yaml"
            ".github/workflows/preview-comment.yaml"
          )

          for workflow in "${workflows[@]}"; do
            if [ ! -f "$workflow" ]; then
              echo "::error::Workflow file not found: $workflow"
              exit 1
            else
              echo " $workflow"
            fi
          done

      - name: Validate workflow syntax
        run: |
          set -eu
          echo "Validating workflow YAML syntax..."

          # Check if yq is available, otherwise skip detailed validation
          if command -v yq &> /dev/null; then
            find .github/workflows -name "*.yaml" -o -name "*.yml" | while read -r file; do
              echo "Validating: $file"
              yq eval '.' "$file" > /dev/null || {
                echo "::error::Invalid YAML syntax in $file"
                exit 1
              }
            done
          else
            echo "yq not available, skipping detailed YAML validation"
          fi

      - name: Test workflow input validation
        run: |
          set -eu
          echo "Checking required inputs for terraform-docs-preview.yaml..."

          # Verify required inputs are documented
          required_inputs="aws_region role_to_assume bucket"
          for input in $required_inputs; do
            if grep -q "$input:" .github/workflows/terraform-docs-preview.yaml; then
              echo " Input '$input' is defined"
            else
              echo "::error::Required input '$input' is missing"
              exit 1
            fi
          done

  summary:
    needs: [test-generate, test-reusable-workflow]
    runs-on: ubuntu-latest
    steps:
      - name: Test Summary
        run: |
          echo " All tests passed!"
          echo "=ø Generated ${{ needs.test-generate.outputs.preview_count }} preview screenshots"
          echo " Reusable workflow validation completed"
