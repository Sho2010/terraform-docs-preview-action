name: Terraform Docs Preview Upload to S3

on:
  workflow_call:
    inputs:
      artifact_name:
        type: string
        required: true
        description: "Name of the artifact containing screenshots to upload"
      aws_region:
        type: string
        required: true
        description: "AWS region for S3 bucket"
      role_to_assume:
        type: string
        required: true
        description: "ARN of the IAM role to assume for AWS credentials"
      bucket:
        type: string
        required: true
        description: "S3 bucket name for storing preview images"
      key_prefix:
        type: string
        default: "terraform-docs-previews"
        description: "Prefix for S3 object keys"
      expires_in:
        type: string
        default: "3600"
        description: "Expiration time in seconds for presigned URLs"
      allow_fork:
        type: string
        default: "false"
        description: "Whether to allow uploads from forked repositories"
    outputs:
      urls:
        value: ${{ jobs.upload.outputs.urls }}

permissions:
  id-token: write
  contents: read

jobs:
  upload:
    # fork PR からの S3 書き込みをデフォルト deny
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name ||
      inputs.allow_fork == 'true'
    runs-on: ubuntu-latest
    outputs:
      urls: ${{ steps.gen.outputs.urls }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ inputs.role_to_assume }}
          aws-region: ${{ inputs.aws_region }}

      - name: Download screenshots artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          path: screenshots

      - name: Upload PNGs to S3 & generate presigned URLs
        id: gen
        env:
          BUCKET: ${{ inputs.bucket }}
          PREFIX: ${{ inputs.key_prefix }}
          EXPIRES_IN: ${{ inputs.expires_in }}
        run: |
          set -eu
          urls=()

          while IFS= read -r file; do
            rel="${file#screenshots/}"
            key="${PREFIX}/${GITHUB_REPOSITORY}/${GITHUB_RUN_ID}/${rel}"

            aws s3 cp "$file" "s3://${BUCKET}/${key}"

            url=$(aws s3 presign "s3://${BUCKET}/${key}" --expires-in "${EXPIRES_IN}")
            urls+=("$url")
          done < <(find screenshots -type f -name "*.png")

          json=$(printf '%s\n' "${urls[@]}" | jq -R . | jq -s .)
          echo "urls=${json}" >> "$GITHUB_OUTPUT"
